# 更新日志 - 股票监控功能

## 2025-11-15 更新

### ✅ 已解决的问题

#### 问题1: Tushare API 权限错误

**症状**: 
```
API返回错误: 抱歉，您没有接口访问权限
```

**原因**: 
- 美股数据接口 (`us_daily`) 需要 Tushare 更高的积分权限
- 免费/基础版 Token 无法访问美股数据

**解决方案**:
1. 临时注释掉美股股票监控（BTCS）
2. 添加权限检测和友好提示
3. 保留港股和A股监控功能

**代码修改**:
- `src/backend/StockMonitor.js`: 注释美股股票
- `src/backend/api/TushareClient.js`: 添加权限警告

#### 问题2: 股票监控未在界面显示

**症状**:
- 前端界面只显示加密货币监控
- 无法看到股票监控状态
- 无法启动/停止股票监控

**解决方案**:
完全重构前端界面，实现双轨监控系统。

**界面改进**:

```
原来的界面:
┌─────────────────┐
│ 加密货币机器人  │
│ 运行状态: 停止  │
│ [启动] [停止]   │
└─────────────────┘

现在的界面:
┌─────────────────────────┐
│ 💰 加密货币监控        │
│ 状态: 运行中           │
│ 监控: BTC/USDT, ETH... │
│ [启动加密] [停止加密]  │
├─────────────────────────┤
│ 📈 股票监控            │
│ 状态: 运行中           │
│ 监控: 腾讯、小米...    │
│ [启动股票] [停止股票]  │
├─────────────────────────┤
│ 活跃任务: 5            │
│ 通知配置: ✓            │
└─────────────────────────┘
```

### 🆕 新增功能

#### 1. 独立的股票监控控制

**新增 IPC 事件**:
- `start-stock-monitor`: 启动股票监控
- `stop-stock-monitor`: 停止股票监控
- `get-stock-monitor-status`: 获取股票监控状态
- `add-stock`: 添加监控股票
- `remove-stock`: 移除监控股票

**新增 IPC 响应**:
- `stock-monitor-status`: 股票监控状态更新
- `stock-monitor-error`: 股票监控错误

#### 2. 分离的状态显示

**加密货币监控**:
- 独立状态指示器
- 监控交易对列表
- 独立控制按钮

**股票监控**:
- 独立状态指示器
- 监控股票列表（显示中文名称）
- 独立控制按钮

#### 3. 改进的用户体验

- ✅ 清晰的功能分区
- ✅ 实时状态更新
- ✅ 友好的错误提示
- ✅ 统一的设计风格

### 📝 当前监控列表

#### 港股 (HK)
- 00700.HK - 腾讯控股
- 01810.HK - 小米集团
- 09988.HK - 阿里巴巴

#### A股 (CN)
- 600519.SH - 贵州茅台

#### 美股 (US)
- ~~BTCS - BTCS Inc~~ (需要更高权限，已注释)

### 🔧 技术改进

#### 1. 错误处理增强

```javascript
// 添加权限检测
if (!hasPermission) {
    logger.warn(`美股数据 ${symbol} 可能需要更高的Tushare权限`);
}

// 优雅降级
if (fetchError) {
    logger.error(`获取数据失败，跳过此股票`);
    return [];
}
```

#### 2. 前端架构优化

**函数重构**:
- `startCryptoBot()` - 启动加密货币监控
- `stopCryptoBot()` - 停止加密货币监控
- `startStockMonitor()` - 启动股票监控
- `stopStockMonitor()` - 停止股票监控
- `updateCryptoStatus()` - 更新加密货币状态
- `updateStockStatus()` - 更新股票监控状态

**状态管理分离**:
- 加密货币和股票监控独立管理
- 互不干扰，可独立启停
- 统一的日志系统

### 📊 测试结果

#### 功能测试

| 功能 | 状态 | 备注 |
|------|------|------|
| Tushare API 连接 | ✅ | Token 有效 |
| 港股数据获取 | ✅ | 腾讯、小米、阿里 |
| A股数据获取 | ✅ | 贵州茅台 |
| 美股数据获取 | ⚠️ | 需要更高权限 |
| 技术指标计算 | ✅ | RSI, MACD, BB |
| AI 分析 | ✅ | DeepSeek 正常 |
| 数据库存储 | ✅ | SQLite 正常 |
| 通知推送 | ✅ | 企业微信、ntfy |
| 前端界面 | ✅ | 双轨监控 |

#### 性能指标

- 数据获取时间: ~1-2秒/股票
- AI 分析时间: ~3-4秒/股票
- 完整监控周期: ~18秒（4只股票）
- 数据库写入: ~10ms/记录

### 🎯 使用建议

#### 1. Tushare 权限升级

如需监控美股，请访问 [Tushare积分商城](https://tushare.pro/document/1?doc_id=108) 了解权限详情。

**权限等级**:
- 基础版（免费）: A股、港股日线数据
- 高级版（积分）: 美股数据、分钟线数据
- 专业版（积分）: 全部数据接口

#### 2. 监控股票管理

**添加新股票**:
```javascript
// 在 StockMonitor.js 的 initializeStocks() 中添加
{ symbol: '03690.HK', name: '美团', market: 'HK' },
{ symbol: '000858.SZ', name: '五粮液', market: 'CN' }
```

**移除股票**:
```javascript
// 直接注释掉不需要的股票
// { symbol: '01810.HK', name: '小米集团', market: 'HK' },
```

#### 3. 定时监控设置

**默认时间**:
- A股: 周一至周五 15:30（收盘后）
- 港股: 周一至周五 16:30（收盘后）
- 美股: 周二至周六 05:00（美东时间16:00收盘）

**自定义时间**:
在 `.env` 文件中修改:
```env
STOCK_MONITOR_CN_TIME="30 15 * * 1-5"
STOCK_MONITOR_HK_TIME="30 16 * * 1-5"
STOCK_MONITOR_US_TIME="0 5 * * 2-6"
```

### 🐛 已知限制

1. **美股数据访问受限**
   - 需要 Tushare 高级积分
   - 临时解决：只监控港股和A股

2. **实时数据延迟**
   - 日线数据有 T+1 延迟
   - 建议收盘后监控

3. **API 调用频率**
   - Tushare 有调用频率限制
   - 避免频繁请求

### 📚 相关文档

- [股票监控使用指南](./STOCK_MONITOR_GUIDE.md)
- [Tushare API 文档](https://tushare.pro/document/2)
- [项目 README](./README.md)

### 🔜 下一步计划

- [ ] 添加更多A股股票监控
- [ ] 支持自选股管理
- [ ] 优化前端界面样式
- [ ] 添加数据可视化图表
- [ ] 支持历史数据回测

---

**更新时间**: 2025-11-15 22:10  
**版本**: v1.1.0  
**状态**: ✅ 已完成并测试
