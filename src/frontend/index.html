<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StockPulse.AI - åŠ å¯†è´§å¸äº¤æ˜“æœºå™¨äºº</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            overflow: hidden;
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
        }

        .container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        .sidebar {
            width: 300px;
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
        }

        h1 {
            font-size: 1.8em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .subtitle {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .status-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status-card h3 {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.8;
        }

        .status-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .status-running {
            color: #4caf50;
        }

        .status-stopped {
            color: #f44336;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        button {
            flex: 1;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 12px 20px;
            font-size: 14px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        button:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-start {
            background: #4caf50;
            border-color: #4caf50;
        }

        .btn-start:hover:not(:disabled) {
            background: #45a049;
        }

        .btn-stop {
            background: #f44336;
            border-color: #f44336;
        }

        .btn-stop:hover:not(:disabled) {
            background: #da190b;
        }

        .log-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: hidden;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .log-header h2 {
            font-size: 1.2em;
        }

        .log-controls {
            display: flex;
            gap: 10px;
        }

        .log-controls button {
            padding: 8px 16px;
            font-size: 12px;
        }

        .log-container {
            flex: 1;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            overflow-y: auto;
            overflow-x: hidden;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 0;
            max-height: 100%;
        }

        .log-container::-webkit-scrollbar {
            width: 8px;
        }

        .log-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .log-container::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 4px;
        }

        .log-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.5);
        }

        .log-entry {
            margin-bottom: 8px;
            padding: 5px 10px;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.2);
            word-wrap: break-word;
            word-break: break-all;
        }

        .log-entry.info {
            border-left: 3px solid #2196f3;
        }

        .log-entry.error {
            border-left: 3px solid #f44336;
            background: rgba(244, 67, 54, 0.1);
        }

        .log-entry.warn {
            border-left: 3px solid #ff9800;
            background: rgba(255, 152, 0, 0.1);
        }

        .log-entry.debug {
            border-left: 3px solid #9e9e9e;
            opacity: 0.7;
        }

        .log-timestamp {
            color: #9e9e9e;
            margin-right: 10px;
        }

        .log-level {
            font-weight: bold;
            margin-right: 10px;
        }

        .log-level.INFO {
            color: #2196f3;
        }

        .log-level.ERROR {
            color: #f44336;
        }

        .log-level.WARN {
            color: #ff9800;
        }

        .log-level.DEBUG {
            color: #9e9e9e;
        }

        .log-message {
            color: #fff;
        }

        .log-json {
            background: rgba(0, 0, 0, 0.5);
            border-left: 3px solid #4caf50;
            padding: 10px;
            margin-top: 5px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .log-json .json-key {
            color: #9cdcfe;
        }

        .log-json .json-string {
            color: #ce9178;
        }

        .log-json .json-number {
            color: #b5cea8;
        }

        .log-json .json-boolean {
            color: #569cd6;
        }

        .log-json .json-null {
            color: #808080;
        }

        .symbols-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .symbol-tag {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
        }

        .empty-log {
            text-align: center;
            padding: 40px;
            opacity: 0.5;
        }

        .notification-status {
            margin-top: 15px;
            font-size: 0.85em;
        }

        .notification-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 8px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-indicator.enabled {
            background: #4caf50;
        }

        .status-indicator.disabled {
            background: #f44336;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar">
            <h1>ğŸš€ StockPulse.AI</h1>
            <p class="subtitle">AIé©±åŠ¨çš„åŠ å¯†è´§å¸å’Œè‚¡ç¥¨äº¤æ˜“åˆ†æç³»ç»Ÿ</p>

            <!-- åŠ å¯†è´§å¸ç›‘æ§çŠ¶æ€ -->
            <div class="status-card">
                <h3>ğŸ’° åŠ å¯†è´§å¸ç›‘æ§</h3>
                <div id="cryptoStatus" class="status-value status-stopped">å·²åœæ­¢</div>
            </div>

            <div class="status-card">
                <h3>ç›‘æ§äº¤æ˜“å¯¹</h3>
                <div id="symbols" class="symbols-list">
                    <span class="symbol-tag">-</span>
                </div>
            </div>

            <!-- è‚¡ç¥¨ç›‘æ§çŠ¶æ€ -->
            <div class="status-card">
                <h3>ğŸ“ˆ è‚¡ç¥¨ç›‘æ§</h3>
                <div id="stockStatus" class="status-value status-stopped">å·²åœæ­¢</div>
            </div>

            <div class="status-card">
                <h3>ç›‘æ§è‚¡ç¥¨</h3>
                <div id="stocks" class="symbols-list">
                    <span class="symbol-tag">-</span>
                </div>
            </div>

            <div class="status-card">
                <h3>æ´»è·ƒä»»åŠ¡</h3>
                <div id="activeJobs" class="status-value">0</div>
            </div>

            <!-- é€šçŸ¥çŠ¶æ€ -->
            <div class="status-card">
                <h3>é€šçŸ¥é…ç½®</h3>
                <div class="notification-status">
                    <div class="notification-item">
                        <span>
                            <span id="emailIndicator" class="status-indicator disabled"></span>
                            é‚®ä»¶é€šçŸ¥
                        </span>
                        <span id="emailStatus">ç¦ç”¨</span>
                    </div>
                    <div class="notification-item">
                        <span>
                            <span id="ntfyIndicator" class="status-indicator disabled"></span>
                            æ¨é€é€šçŸ¥
                        </span>
                        <span id="ntfyStatus">ç¦ç”¨</span>
                    </div>
                    <div class="notification-item">
                        <span>
                            <span id="wecomIndicator" class="status-indicator disabled"></span>
                            ä¼ä¸šå¾®ä¿¡
                        </span>
                        <span id="wecomStatus">ç¦ç”¨</span>
                    </div>
                </div>
            </div>

            <!-- æŒ‰é’®ç»„ -->
            <div class="button-group">
                <button id="startCryptoBtn" class="btn-start" onclick="startCryptoBot()">å¯åŠ¨åŠ å¯†</button>
                <button id="stopCryptoBtn" class="btn-stop" onclick="stopCryptoBot()" disabled>åœæ­¢åŠ å¯†</button>
            </div>
            <div class="button-group">
                <button id="startStockBtn" class="btn-start" onclick="startStockMonitor()">å¯åŠ¨è‚¡ç¥¨</button>
                <button id="stopStockBtn" class="btn-stop" onclick="stopStockMonitor()" disabled>åœæ­¢è‚¡ç¥¨</button>
            </div>
            <div class="button-group">
                <button onclick="getStatus()">åˆ·æ–°çŠ¶æ€</button>
                <button onclick="getConfig()">è·å–é…ç½®</button>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <div class="log-section">
                <div class="log-header">
                    <h2>ğŸ“‹ è¿è¡Œæ—¥å¿—</h2>
                    <div class="log-controls">
                        <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
                        <button onclick="toggleAutoScroll()">
                            <span id="autoScrollText">è‡ªåŠ¨æ»šåŠ¨: å¼€</span>
                        </button>
                    </div>
                </div>
                <div id="logContainer" class="log-container">
                    <div class="empty-log">ç­‰å¾…æ—¥å¿—è¾“å‡º...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { ipcRenderer } = require('electron');
        
        let autoScroll = true;
        let logs = [];

        // å¯åŠ¨åŠ å¯†è´§å¸æœºå™¨äºº
        function startCryptoBot() {
            ipcRenderer.send('start-bot');
            document.getElementById('startCryptoBtn').disabled = true;
            addLog('INFO', 'æ­£åœ¨å¯åŠ¨åŠ å¯†è´§å¸æœºå™¨äºº...');
        }

        // åœæ­¢åŠ å¯†è´§å¸æœºå™¨äºº
        function stopCryptoBot() {
            ipcRenderer.send('stop-bot');
            document.getElementById('stopCryptoBtn').disabled = true;
            addLog('INFO', 'æ­£åœ¨åœæ­¢åŠ å¯†è´§å¸æœºå™¨äºº...');
        }

        // å¯åŠ¨è‚¡ç¥¨ç›‘æ§
        function startStockMonitor() {
            ipcRenderer.send('start-stock-monitor');
            document.getElementById('startStockBtn').disabled = true;
            addLog('INFO', 'æ­£åœ¨å¯åŠ¨è‚¡ç¥¨ç›‘æ§...');
        }

        // åœæ­¢è‚¡ç¥¨ç›‘æ§
        function stopStockMonitor() {
            ipcRenderer.send('stop-stock-monitor');
            document.getElementById('stopStockBtn').disabled = true;
            addLog('INFO', 'æ­£åœ¨åœæ­¢è‚¡ç¥¨ç›‘æ§...');
        }

        // è·å–çŠ¶æ€
        function getStatus() {
            ipcRenderer.send('get-status');
            ipcRenderer.send('get-stock-monitor-status');
        }

        // è·å–é…ç½®
        function getConfig() {
            ipcRenderer.send('get-config');
        }

        // æ¸…ç©ºæ—¥å¿—
        function clearLogs() {
            logs = [];
            const logContainer = document.getElementById('logContainer');
            logContainer.innerHTML = '<div class="empty-log">æ—¥å¿—å·²æ¸…ç©º</div>';
        }

        // åˆ‡æ¢è‡ªåŠ¨æ»šåŠ¨
        function toggleAutoScroll() {
            autoScroll = !autoScroll;
            document.getElementById('autoScrollText').textContent = 
                `è‡ªåŠ¨æ»šåŠ¨: ${autoScroll ? 'å¼€' : 'å…³'}`;
        }

        // æ·»åŠ æ—¥å¿—æ¡ç›®
        function addLog(level, message) {
            const timestamp = new Date().toLocaleTimeString('zh-CN', { hour12: false });
            const logEntry = { timestamp, level, message };
            logs.push(logEntry);

            const logContainer = document.getElementById('logContainer');
            
            // å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ—¥å¿—ï¼Œæ¸…ç©ºæç¤ºä¿¡æ¯
            if (logContainer.querySelector('.empty-log')) {
                logContainer.innerHTML = '';
            }

            const logElement = document.createElement('div');
            logElement.className = `log-entry ${level.toLowerCase()}`;
            
            // å°è¯•æ£€æµ‹å¹¶æ ¼å¼åŒ– JSON å†…å®¹
            const { formattedMessage, hasJson } = formatLogMessage(message);
            
            logElement.innerHTML = `
                <span class="log-timestamp">${timestamp}</span>
                <span class="log-level ${level}">[${level}]</span>
                <span class="log-message">${formattedMessage}</span>
            `;
            
            logContainer.appendChild(logElement);

            // é™åˆ¶æ—¥å¿—æ•°é‡
            if (logs.length > 500) {
                logs.shift();
                logContainer.removeChild(logContainer.firstChild);
            }

            // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            if (autoScroll) {
                logContainer.scrollTop = logContainer.scrollHeight;
            }
        }

        // æ ¼å¼åŒ–æ—¥å¿—æ¶ˆæ¯ï¼Œç¾åŒ– JSON æ˜¾ç¤º
        function formatLogMessage(message) {
            let hasJson = false;
            let formattedMessage = escapeHtml(message);

            // å°è¯•æ£€æµ‹ JSON å¯¹è±¡æˆ–æ•°ç»„
            const jsonRegex = /(\{[\s\S]*?\}|\[[\s\S]*?\])/g;
            const matches = message.match(jsonRegex);

            if (matches) {
                matches.forEach(match => {
                    try {
                        const parsed = JSON.parse(match);
                        const prettified = JSON.stringify(parsed, null, 2);
                        const highlighted = syntaxHighlightJson(prettified);
                        formattedMessage = formattedMessage.replace(
                            escapeHtml(match),
                            `<br><div class="log-json">${highlighted}</div>`
                        );
                        hasJson = true;
                    } catch (e) {
                        // ä¸æ˜¯æœ‰æ•ˆçš„ JSONï¼Œä¿æŒåŸæ ·
                    }
                });
            }

            return { formattedMessage, hasJson };
        }

        // JSON è¯­æ³•é«˜äº®
        function syntaxHighlightJson(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        // HTMLè½¬ä¹‰
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ›´æ–°åŠ å¯†è´§å¸çŠ¶æ€æ˜¾ç¤º
        function updateCryptoStatus(status) {
            const statusElement = document.getElementById('cryptoStatus');
            statusElement.textContent = status.isRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
            statusElement.className = status.isRunning ? 'status-value status-running' : 'status-value status-stopped';

            // æ›´æ–°ç›‘æ§äº¤æ˜“å¯¹
            const symbolsElement = document.getElementById('symbols');
            if (status.monitoredSymbols && status.monitoredSymbols.length > 0) {
                symbolsElement.innerHTML = status.monitoredSymbols
                    .map(s => `<span class="symbol-tag">${s}</span>`)
                    .join('');
            } else {
                symbolsElement.innerHTML = '<span class="symbol-tag">-</span>';
            }

            // æ›´æ–°æ´»è·ƒä»»åŠ¡æ•°
            document.getElementById('activeJobs').textContent = status.activeScheduledJobs || 0;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('startCryptoBtn').disabled = status.isRunning;
            document.getElementById('stopCryptoBtn').disabled = !status.isRunning;
        }

        // æ›´æ–°è‚¡ç¥¨ç›‘æ§çŠ¶æ€æ˜¾ç¤º
        function updateStockStatus(status) {
            const statusElement = document.getElementById('stockStatus');
            statusElement.textContent = status.isRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢';
            statusElement.className = status.isRunning ? 'status-value status-running' : 'status-value status-stopped';

            // æ›´æ–°ç›‘æ§è‚¡ç¥¨
            const stocksElement = document.getElementById('stocks');
            if (status.monitoredStocks && status.monitoredStocks.length > 0) {
                stocksElement.innerHTML = status.monitoredStocks
                    .map(s => `<span class="symbol-tag">${s.name || s.symbol}</span>`)
                    .join('');
            } else {
                stocksElement.innerHTML = '<span class="symbol-tag">-</span>';
            }

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.getElementById('startStockBtn').disabled = status.isRunning;
            document.getElementById('stopStockBtn').disabled = !status.isRunning;
        }

        // æ›´æ–°é€šçŸ¥é…ç½®æ˜¾ç¤º
        function updateConfig(config) {
            // æ›´æ–°é‚®ä»¶é€šçŸ¥çŠ¶æ€
            const emailEnabled = config.ENABLE_EMAIL_NOTIFICATION === true;
            document.getElementById('emailIndicator').className = 
                emailEnabled ? 'status-indicator enabled' : 'status-indicator disabled';
            document.getElementById('emailStatus').textContent = emailEnabled ? 'å¯ç”¨' : 'ç¦ç”¨';

            // æ›´æ–°æ¨é€é€šçŸ¥çŠ¶æ€
            const ntfyEnabled = config.ENABLE_NTFY_NOTIFICATION === true;
            document.getElementById('ntfyIndicator').className = 
                ntfyEnabled ? 'status-indicator enabled' : 'status-indicator disabled';
            document.getElementById('ntfyStatus').textContent = ntfyEnabled ? 'å¯ç”¨' : 'ç¦ç”¨';

            // æ›´æ–°ä¼ä¸šå¾®ä¿¡é€šçŸ¥çŠ¶æ€
            const wecomEnabled = config.ENABLE_WECOM_NOTIFICATION === true;
            document.getElementById('wecomIndicator').className = 
                wecomEnabled ? 'status-indicator enabled' : 'status-indicator disabled';
            document.getElementById('wecomStatus').textContent = wecomEnabled ? 'å¯ç”¨' : 'ç¦ç”¨';

            addLog('INFO', `é€šçŸ¥é…ç½®å·²æ›´æ–° - é‚®ä»¶: ${emailEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}, æ¨é€: ${ntfyEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}, ä¼ä¸šå¾®ä¿¡: ${wecomEnabled ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
        }

        // ç›‘å¬æ¥è‡ªä¸»è¿›ç¨‹çš„æ¶ˆæ¯
        ipcRenderer.on('bot-status', (event, status) => {
            updateCryptoStatus(status);
            addLog('INFO', `åŠ å¯†è´§å¸çŠ¶æ€æ›´æ–°: ${status.isRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}`);
        });

        ipcRenderer.on('bot-config', (event, config) => {
            updateConfig(config);
        });

        ipcRenderer.on('bot-error', (event, error) => {
            updateCryptoStatus({ isRunning: false });
            addLog('ERROR', `é”™è¯¯: ${error}`);
            document.getElementById('startCryptoBtn').disabled = false;
            document.getElementById('stopCryptoBtn').disabled = true;
        });

        // ç›‘å¬è‚¡ç¥¨ç›‘æ§çŠ¶æ€
        ipcRenderer.on('stock-monitor-status', (event, status) => {
            updateStockStatus(status);
            addLog('INFO', `è‚¡ç¥¨ç›‘æ§çŠ¶æ€æ›´æ–°: ${status.isRunning ? 'è¿è¡Œä¸­' : 'å·²åœæ­¢'}`);
        });

        // ç›‘å¬è‚¡ç¥¨ç›‘æ§é”™è¯¯
        ipcRenderer.on('stock-monitor-error', (event, error) => {
            updateStockStatus({ isRunning: false });
            addLog('ERROR', `è‚¡ç¥¨ç›‘æ§é”™è¯¯: ${error}`);
            document.getElementById('startStockBtn').disabled = false;
            document.getElementById('stopStockBtn').disabled = true;
        });

        ipcRenderer.on('bot-log', (event, { level, message }) => {
            addLog(level, message);
        });

        // é¡µé¢åŠ è½½æ—¶è·å–åˆå§‹çŠ¶æ€å’Œé…ç½®
        window.onload = () => {
            getStatus();
            getConfig();
            addLog('INFO', 'StockPulse.AI ç•Œé¢å·²åŠ è½½');
        };
    </script>
</body>
</html>
